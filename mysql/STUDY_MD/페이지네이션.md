# 페이지네이션이란

- 1000개가 넘는 게시물들을 한 화면에 어떻게 노출 할 것인가
- 많은 양의 데이터를 어떻게 노출시킬 것인가

![pagination-infinitescroll.png](..%2FIMAGE%2Fpagination-infinitescroll.png)
- 왼쪽은 페이지네이션, 오른쪽은 무한 스크롤

## 페이지네이션 예시
- 게시물이 6개가 있다고 하자.

- `클라이언트 --(page 0 , size 2)--> 서버` 이런 요청이 왔다.
  - 서버는 이 page와 size를 가지고 **1번, 2번 게시물과 totalPages 또는 totalElements**도 같이 줌!
- `클라이언트 --(page 1 , size 2)--> 서버` 이런 요청이 왔다.
  - 서버는 이 page와 size를 가지고 **3번, 4번 게시물과 totalPages 또는 totalElements**도 같이 줌!

---
- DB는 3번, 4번 데이터를 찾아가는 동안 DB는 1, 2번 데이터를 스캔 한다
- 마지막 페이지를 구하기 위해 전체 갯수를 알아야 함!

# 오프셋 기반 페이징 구현의 문제

- 마지막 페이지를 구하기 위해 전체 갯수를 알아야함!
- offset=4, size=2 라고 클라이언트가 보내면
  - 4번 offset부터 시작하기 위해서 **0~3번 Offset까지 데이터를 다시 읽어야함!**
  - 커지면 커질수록 불리해짐 
  - 불필요한 조회 발생!

# 오프셋 기반 해결 위한 **커서 기반 페이징**
- 커서방식에서는 꼭 키에 해당하는 값을 정렬 해야함
- 중복키도 없어야함! 인덱스가 있어야하고, 중복된 가능성이 전혀 없어야 함
- key=4 , size =2
  - 4번이전의 데이터를 보지 않고, 다음 2번의 데이터를 줌
  - 커서기반 페이징은 키를 기준으로 데이터 탐색범위를 최소화함
  - 커서기반 페이징은 전체 데이터를 조회하지 않기 때문에, 아래 UI 구현이 어려움
    - 하지만 이게 오프셋 기반 페이징 보다 무조건 좋은건아니다! 기획에 따라 달라질 수 있다!
 - 또한 다른 해결 방법인 커버링 인덱스도 있고, 다양한 방법이 있다


# 커버링 인덱스 
- SQL문이 들어오면 바로 테이블을 가는 것 보다  **인덱스 테이블을 거쳐서 테이블로 가는 것이 훨씬 빠르다**
- 검색조건이 인덱스에 부합하다면, 테이블에 바로 접근 하는 것보다 
- < **인덱스를 통해 접근 하는 것이 매우 빠르다!**

- 그렇다면 테이블에 접근하지 않고 인덱스로만 데이터 응답을 내려줄 수 없을까?

---
- 만약 나이 인덱스 가 존재 하고,

| 나이 | id |
|----|----|
| 19 | 3  |
| 27 | 2  |
| 32 | 1  |


- 쿼리는 아래와 같다고 하자


```sql
SELECT 나이
FROM  Member 
WHERE 나이 > 30
```
- 여기서 필요한 데이터는 나이 하나! 그럼 그냥 인덱스 테이블 접근으로 바로 끝난다!
- 그럼 아래와 같이 id 가 추가 되면?

```sql
SELECT 나이 ,id
FROM  Member 
WHERE 나이 > 30
```
- MySQL 에서는 PK가 클러스터 인덱스이기 때문에 
- **커버링 인덱스에 유리!**

#### 커버링 인덱스로 페이지네이션 최적화를 어떻게할 수 있을까?
나이가 30 이하인 회원의 이름을 2개만 조회 
 
```sql
with 커버링 as (
    SELECT id 
    FROM 회원
    WHERE 나이 < 30
    LIMIT 2
)

SELECT 이름
FROM 회원 INNER JOIN 커버링 on 회원.id = 커버링.id
```
- LIMIT, ORDER BY, OFFSET을 사용하면 불필요한 데이터를 랜덤 I/O 접근을 줄이는 것!

> 즉, order by, offset, limit 절로 인한 불필요한 데이터블록 접근을 커버링 인덱스를 통해 최소화!
